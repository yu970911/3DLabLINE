# GAS イベント/トリガー設計（状態遷移表）v1.0

対象: Phase1（当日参加導線・基本管理）を中心に、LINE Webhook受信と時間トリガーの設計を定義。

## 前提
- LINE Messaging API のWebhookイベントをGAS Webアプリで受信
- 友だち状態は `友だち一覧.状態` で管理
- 基本状態: `種別待ち/名前待ち/WSコード待ち/通常`
- `種別待ち`: 友だち追加直後の用途選択
- `名前待ち`: フルネーム未取得
- `WSコード待ち`: 当日参加のWS特定が必要な場合に使用（Phase1で使う/使わないは運用で選択）

---

## 1) Webhookイベント設計

### 1.1 follow イベント（友だち追加）
- 受信: `event.type = follow`
- 処理:
  - 友だち一覧に新規行を作成（LINEユーザーID, 表示名, 状態=`種別待ち`）
  - 友だち状態が既存なら更新（ブロック解除想定）
  - 用途選択メッセージを返信（当日参加/事前登録/情報のみ）

### 1.2 unfollow イベント（ブロック）
- 受信: `event.type = unfollow`
- 処理:
  - 友だち一覧の最終アクション日時のみ更新
  - 状態は維持（削除しない）

### 1.3 message イベント（テキスト）
- 受信: `event.type = message` / `message.type = text`
- 処理: 状態に応じて分岐
  - `種別待ち`:
    - 受信テキストが `当日参加/事前登録/情報のみ` のいずれか
      - 当日参加: 状態→`名前待ち`
      - 事前登録: 状態→`名前待ち`（見込みとして記録）
      - 情報のみ: 状態→`通常`（見込みとして記録）
    - その他: 用途選択を再提示
  - `名前待ち`:
    - 受信テキストをフルネームとして保存
    - 区分に応じた分岐
      - 当日参加: 状態→`通常` or `WSコード待ち`
      - 事前登録: 状態→`通常`
    - 次の案内を返信
  - `WSコード待ち`:
    - 受信テキストをワークショップIDとして照合
    - 有効なら参加登録→状態`通常`
    - 無効なら再入力依頼
  - `通常`:
    - 受信テキストに応じて各機能へルーティング（当日参加/クーポン/アンケート/問い合わせ）

### 1.4 postback イベント（リッチメニュー/Quick Reply）
- 受信: `event.type = postback`
- 処理:
  - `data` をキーにルーティング（例: `action=join_today`）
  - 状態に依存する場合は状態優先

---

## 2) 時間トリガー設計（自動配信）

### 2.1 リマインド配信
- トリガー: 5分おき or 1時間おきの時間トリガー
- 処理:
  - `ワークショップ開催管理` から `リマインド送信日時` が現在時刻以下、`有効=TRUE` を抽出
  - 対象者（参加者一覧 or 予約連携対象）へ送信
  - `参加者一覧.リマインド送信日時` を更新
  - `送信履歴` に記録

### 2.2 お礼 + アンケート送信
- トリガー: 5分おき or 1時間おき
- 処理:
  - `ワークショップ開催管理` から `お礼送信日時` が現在時刻以下、`有効=TRUE` を抽出
  - `参加者一覧` の該当WS参加者へ送信
  - `参加者一覧.お礼送信日時` 更新
  - `送信履歴` に記録

---

## 3) 状態遷移表（Phase1中心）

| 現在状態 | 受信 | 条件 | 次状態 | 主処理 | 備考 |
|---|---|---|---|---|---|
| （未登録） | follow | - | 種別待ち | 友だち追加/用途選択送信 | 初回登録 |
| 種別待ち | text | 当日参加 | 名前待ち | 区分=参加者見込みで仮登録 | - |
| 種別待ち | text | 事前登録 | 名前待ち | 区分=見込みで仮登録 | - |
| 種別待ち | text | 情報のみ | 通常 | 区分=見込みで登録 | - |
| 種別待ち | text | その他 | 種別待ち | 用途選択再提示 | - |
| 名前待ち | text | 文字列 | 通常 | フルネーム保存/案内送信 | WSコード待ち運用に切替可 |
| WSコード待ち | text | WS有効 | 通常 | 参加登録/当日URL送信 | - |
| WSコード待ち | text | WS無効 | WSコード待ち | 再入力依頼 | - |
| 通常 | text | 当日参加 | 名前待ち | 参加フロー再開 | - |
| 通常 | text | アンケート | 通常 | SURVEY_URL送信 | - |
| 通常 | text | クーポン | 通常 | 条件判定して返信 | Phase1では手動可 |
| 通常 | text | 問い合わせ | 通常 | 定型文/スタッフ通知 | - |

---

## 4) ルーティング規約（提案）

### 4.1 受信テキストの正規化
- 全角/半角・大小は簡易正規化
- ルーティング対象キーワード:
  - 当日参加
  - 事前登録
  - 情報のみ
  - 案内
  - クーポン
  - アンケート
  - 問い合わせ

### 4.2 postback data 例
- `action=join_today`
- `action=pre_register`
- `action=info_only`
- `action=survey`
- `action=coupon`
- `action=contact`

---

## 5) 実装メモ
- Webhookは `doPost(e)` で受信
- 署名検証は必須（チャネルシークレット）
- 返信/プッシュの区別は `replyToken` 有無で判断
- すべての送信は `送信履歴` に記録
- 例外はログ記録して処理を止めない
