# Phase1 詳細設計（当日参加フロー）v1.0

目的: 当日参加導線・基本管理の実装仕様を明確化する。
対象: 友だち追加〜当日参加登録まで。

---

## 1) シナリオ概要

### 1.1 初回登録〜用途選択
- 友だち追加 → 用途選択メッセージ送信
- 選択肢: 当日参加 / 事前登録 / 情報のみ

### 1.2 当日参加フロー（基本）
- 用途選択で「当日参加」
- フルネーム取得
- 当日使用URL送信
- 参加履歴へ保存

---

## 2) シート更新仕様

### 2.1 友だち一覧
- follow時: 新規作成（LINEユーザーID/表示名/状態=種別待ち）
- 用途選択後:
  - 当日参加: 区分=参加者, 状態=名前待ち
  - 事前登録: 区分=見込み, 状態=名前待ち
  - 情報のみ: 区分=見込み, 状態=通常
- フルネーム取得後:
  - フルネーム保存
  - 状態=通常
  - 最終アクション日時更新

### 2.2 参加者一覧（参加履歴）
- 当日参加のフルネーム取得後に追加
- 保存項目:
  - ワークショップID（Phase1では「最新有効WS」を自動選択）
  - LINEユーザーID
  - フルネーム
  - 参加区分=当日
  - 参加日時=現在時刻

### 2.3 ワークショップ開催管理
- Phase1では「有効=TRUE」「開催日=本日以降」から最も近いWSを採用
- 当日使用URLはここから取得

---

## 3) フロー詳細（状態遷移 + 返信）

### 3.1 followイベント
- 状態: 未登録 → 種別待ち
- 返信: 用途選択メッセージ

### 3.2 種別待ちでのテキスト受信
- 「当日参加」→ 状態: 名前待ち
- 「事前登録」→ 状態: 名前待ち
- 「情報のみ」→ 状態: 通常
- その他 → 用途選択メッセージ再送

### 3.3 名前待ちでのテキスト受信
- 受信テキストをフルネームとして保存
- 当日参加の場合:
  - 当日使用URL取得
  - 参加履歴追加
  - 当日案内メッセージ返信
- 事前登録の場合:
  - 見込み登録完了メッセージ返信

---

## 4) メッセージ仕様（Phase1）

### 4.1 用途選択メッセージ
- メッセージID: MSG-001
- Quick Reply: 当日参加 / 事前登録 / 情報のみ

### 4.2 氏名入力依頼
- メッセージID: MSG-002
- 例: 「フルネームを入力してください」

### 4.3 当日案内
- メッセージID: MSG-003
- 差し込み: `{FULL_NAME}` `{JOIN_URL}`

### 4.4 見込み登録完了
- メッセージID: MSG-004

---

## 5) 例外・バリデーション
- 名前が1文字以下の場合は再入力依頼
- WSが取得できない場合は「スタッフへ問い合わせ」メッセージ
- 参加履歴重複（同日同WS）は登録しない

---

## 6) 送信履歴記録
- 返信/プッシュの区別
- 使用メッセージID
- 送信本文（差し込み済み）
- 送信結果/レスポンス

---

## 7) 実装メモ
- 友だち一覧の「最終参加ワークショップID」は当日参加完了時に更新
- 参加回数は後続フェーズで集計更新
- 送信本文は「メッセージ管理」から取得して差し込み
